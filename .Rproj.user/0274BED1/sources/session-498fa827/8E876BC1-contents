library(MASS)
library(dplyr)
library(olsrr)
library(car)
library(caret)


data_train <- read.csv(
  '/Users/mikkezavala/Library/Mobile Documents/com~apple~CloudDocs/Documents/School/Master in Data Science/[DS-6371] Statistical Foundations for Data Science/Final Project/train.csv'
)

data_test <- read.csv(
  '/Users/mikkezavala/Library/Mobile Documents/com~apple~CloudDocs/Documents/School/Master in Data Science/[DS-6371] Statistical Foundations for Data Science/Final Project/test.csv'
)
# LotConfig*
filtered_columns <- c(
  "Id",
  "RoofStyle",
  "RoofMatl",
  "LowQualFinSF",
  "BsmtHalfBath",
  "MiscVal",
  "MoSold",
  "YrSold",
  "Street",
  "Utilities",
  "TotRmsAbvGrd"
)

filtered_data <- data_train |>
  filter(!Id %in% c(534, 1299))  |>
  dplyr::select(-all_of(filtered_columns))

filtered_test_data <- data_test |>
  dplyr::select(-all_of(filtered_columns))


filtered_data

build_factor <- function(data, reference = NULL) {
  for (col in colnames(data)) {
    if (!is.numeric(data[[col]])) {
      data[[col]][is.na(data[[col]])] <- "None"
      if (!is.null(reference)) {
        known_levels <- levels(reference[[col]])
        data[[col]] <- factor(data[[col]], levels = known_levels)
        data[[col]][is.na(data[[col]])] <- "None"
      } else {
        data[[col]] <- factor(data[[col]])
      }
    } else {
      data[[col]][is.na(data[[col]])] <- median(data[[col]], na.rm = TRUE)
    }
  }
  return(data)
}

encode <- function(data_train) {
  data <- build_factor(data_train)
  dm_model <- dummyVars(~ . - SalePrice, data = data_train, fullRank = TRUE)
  encoded_data <- predict(dm_model, newdata = data_train)
  
  encoded_data <- as.data.frame(encoded_data)
  encoded_data$SalePrice <- data_train$SalePrice
  
  return(encoded_data)
}

alpha <- 0.05
df_train <- build_factor(filtered_data)
fit <- lm(SalePrice ~ ., data = df_train)

alias_output <- alias(fit)
print(alias_output)
vif(fit)


summary(fit)
str(df_train)

ols_step_both_p(
  fit,
  p_enter = alpha,
  p_remove = alpha,
  print_plot = TRUE,
  progress = TRUE,
  details = TRUE
)

ols_step_backward_p(
  fit,
  p_val = alpha,
  progress = TRUE,
  details = TRUE,
  print_plot = TRUE
)

ols_step_forward_p(
  fit,
  p_val = alpha,
  progress = TRUE,
  details = TRUE,
  print_plot = TRUE
)

formula_stpw <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + GarageCars + MSSubClass + KitchenQual + YearBuilt + RoofMatl + LotArea + OverallCond + TotalBsmtSF + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + ExterQual + PoolArea + BsmtExposure + X2ndFlrSF + MasVnrType + Neighborhood + SaleCondition + PoolQC + ScreenPorch + TotRmsAbvGrd + LowQualFinSF + Street + LandSlope + GarageYrBlt + Fireplaces + BldgType
formula_back <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + GarageCars + MSSubClass + KitchenQual + YearBuilt + RoofMatl + LotArea + OverallCond + TotalBsmtSF + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + ExterQual + PoolArea + BsmtExposure + X2ndFlrSF + MasVnrType + Neighborhood + SaleCondition + PoolQC + ScreenPorch + TotRmsAbvGrd + LowQualFinSF + Street + LandSlope + GarageYrBlt + Fireplaces + BldgType
formula_frwd <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + GarageCars + MSSubClass + KitchenQual + YearBuilt + RoofMatl + LotArea + OverallCond + TotalBsmtSF + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + ExterQual + PoolArea + BsmtExposure + X2ndFlrSF + MasVnrType + Neighborhood + SaleCondition + PoolQC + ScreenPorch + TotRmsAbvGrd + LowQualFinSF + Street + LandSlope + GarageYrBlt + Fireplaces + BldgType

formula_stpw_filter <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + TotalBsmtSF + GarageArea + KitchenQual + LotArea + YearBuilt + MSSubClass + OverallCond + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + X2ndFlrSF + BsmtExposure + ExterQual + PoolArea + MasVnrType + Neighborhood + SaleCondition + Street + RoofMatl + PoolQC + ScreenPorch + TotRmsAbvGrd + LowQualFinSF + LandSlope + Fireplaces + GarageYrBlt + Functional + Condition1 + LandContour
formula_back_filter <- SalePrice ~ LotArea + Street + LandContour + LotConfig + LandSlope + Neighborhood + Condition1 + Condition2 + BldgType + OverallQual + OverallCond + YearBuilt + YearRemodAdd + RoofMatl + Exterior1st + MasVnrArea + ExterQual + BsmtQual + BsmtExposure + BsmtFinSF1 + BsmtFinSF2 + BsmtUnfSF + TotalBsmtSF + X1stFlrSF + X2ndFlrSF + LowQualFinSF + GrLivArea + BedroomAbvGr + KitchenAbvGr + KitchenQual + TotRmsAbvGrd + Functional + Fireplaces + GarageCars + GarageArea + GarageQual + GarageCond + WoodDeckSF + ScreenPorch + PoolArea + PoolQC + MoSold + SaleCondition
# Winning: 0.16499*
formula_frwd_filter <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + TotalBsmtSF + GarageArea + YearRemodAdd + KitchenQual + LotArea + YearBuilt + MSSubClass + OverallCond + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + X2ndFlrSF + BsmtExposure + ExterQual + PoolArea + MasVnrType + Neighborhood + SaleCondition + RoofMatl + PoolQC + ScreenPorch + TotRmsAbvGrd + LowQualFinSF + Street + LandSlope + Fireplaces + Functional + Condition1 + LandContour + GarageFinish

# Score: 0.17020
formula_back_filter_plus_GarageYrBlt_MSSubClass_MasVnrType <- SalePrice ~ BedroomAbvGr + BldgType + BsmtExposure + BsmtFinSF1 + BsmtFinSF2 + BsmtQual + BsmtUnfSF + Condition1 + Condition2 + ExterQual + Exterior1st + Fireplaces + Functional + GarageArea + GarageCars + GarageCond + GarageQual + GarageYrBlt + GrLivArea + KitchenAbvGr + KitchenQual + LandContour + LandSlope + LotArea + LotConfig + LowQualFinSF + MSSubClass + MasVnrArea + MasVnrType + MoSold + Neighborhood + OverallCond + OverallQual + PoolArea + PoolQC + RoofMatl + SaleCondition + ScreenPorch + Street + TotRmsAbvGrd + TotalBsmtSF + WoodDeckSF + X1stFlrSF + X2ndFlrSF + YearBuilt + YearRemodAdd
# Winning: 0.16497*
formula_frwd_filter_plus_GarageYrBlt <- SalePrice ~ BedroomAbvGr + BsmtExposure + BsmtFinSF1 + BsmtQual + Condition1 + Condition2 + ExterQual + Fireplaces + Functional + GarageArea + GarageFinish + GarageYrBlt + GrLivArea + KitchenAbvGr + KitchenQual + LandContour + LandSlope + LotArea + LowQualFinSF + MSSubClass + MasVnrArea + MasVnrType + Neighborhood + OverallCond + OverallQual + PoolArea + PoolQC + RoofMatl + SaleCondition + ScreenPorch + Street + TotRmsAbvGrd + TotalBsmtSF + X2ndFlrSF + YearBuilt + YearRemodAdd

# Winning: 0.15592
formula_stw_corr <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + TotalBsmtSF + GarageArea + KitchenQual + LotArea + YearBuilt + MSSubClass + OverallCond + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + X2ndFlrSF + BsmtExposure + ExterQual + PoolArea + MasVnrType + Neighborhood + SaleCondition + PoolQC + ScreenPorch + TotRmsAbvGrd + WoodDeckSF + LandSlope + Fireplaces + Functional
# BAADDDD!!!
formula_stb_corr <- SalePrice ~ MSZoning + LotArea + LotConfig + LandSlope + Neighborhood + Condition1 + Condition2 + BldgType + OverallQual + OverallCond + YearBuilt + YearRemodAdd + Exterior1st + MasVnrType + MasVnrArea + ExterQual + BsmtQual + BsmtExposure + BsmtFinSF1 + BsmtFinSF2 + BsmtUnfSF + TotalBsmtSF + X1stFlrSF + X2ndFlrSF + BedroomAbvGr + KitchenAbvGr + KitchenQual + TotRmsAbvGrd + Functional + Fireplaces + GarageCars + GarageArea + GarageQual + GarageCond + WoodDeckSF + ScreenPorch + PoolArea + PoolQC + SaleCondition
# Score: 0.15664
formula_fwd_corr <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + TotalBsmtSF + GarageArea + YearRemodAdd + KitchenQual + LotArea + YearBuilt + MSSubClass + OverallCond + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + X2ndFlrSF + BsmtExposure + ExterQual + PoolArea + MasVnrType + Neighborhood + SaleCondition + PoolQC + ScreenPorch + TotRmsAbvGrd + Fireplaces + LandSlope + Functional + WoodDeckSF


#### -- diff of good models
# Score: 0.15711
formula_fwd_corr_plus_Condition1_GarageFinish_LandContour <- SalePrice ~ BedroomAbvGr + BsmtExposure + BsmtFinSF1 + BsmtQual + Condition1 + Condition2 + ExterQual + Fireplaces + Functional + GarageArea + GarageFinish + GrLivArea + KitchenAbvGr + KitchenQual + LandContour + LandSlope + LotArea + MSSubClass + MasVnrArea + MasVnrType + Neighborhood + OverallCond + OverallQual + PoolArea + PoolQC + SaleCondition + ScreenPorch + TotRmsAbvGrd + TotalBsmtSF + WoodDeckSF + X2ndFlrSF + YearBuilt + YearRemodAdd
# Score: 0.15664
formula_stw_corr_plus_YearRemodAdd <- SalePrice ~ BedroomAbvGr + BsmtExposure + BsmtFinSF1 + BsmtQual + Condition2 + ExterQual + Fireplaces + Functional + GarageArea + GrLivArea + KitchenAbvGr + KitchenQual + LandSlope + LotArea + MSSubClass + MasVnrArea + MasVnrType + Neighborhood + OverallCond + OverallQual + PoolArea + PoolQC + SaleCondition + ScreenPorch + TotRmsAbvGrd + TotalBsmtSF + WoodDeckSF + X2ndFlrSF + YearBuilt + YearRemodAdd

### ---- Apmputing vars
formula_frwd_filter_pass_2 <- SalePrice ~ OverallQual + GrLivArea + BsmtFinSF1 + TotalBsmtSF + GarageArea + YearRemodAdd + KitchenQual + LotArea + YearBuilt + MSSubClass + OverallCond + BedroomAbvGr + BsmtQual + Condition2 + MasVnrArea + KitchenAbvGr + X2ndFlrSF + BsmtExposure + ExterQual + PoolArea + MasVnrType + Neighborhood + SaleCondition + PoolQC + ScreenPorch  + LandSlope + Fireplaces + Functional + Condition1 + LandContour + GarageFinish

data_test$SalePrice <- 34900
fit_predict <- lm(formula_frwd_filter_pass_2, data = df_train)
data_test$SalePrice <- predict(fit_predict, newdata = build_factor(filtered_test_data, df_train))

vif(fit_predict)

data_test$SalePrice[is.na(data_test$SalePrice)] <- 34900

output <- data_test |> dplyr::select("Id", "SalePrice")
output
write.csv(output, file = "/Users/mikkezavala/Desktop/tests/formula_stw_corr_plus_YearRemodAdd.csv", row.names = FALSE)

write.csv(df_train_encoded, file = "/Users/mikkezavala/Desktop/tests/formula_stb_corr.csv", row.names = FALSE)
